services:
  # -----------------------------------------------------------
  # 1. API GATEWAY (PINTU UTAMA) - INI YANG KURANG TADI
  # -----------------------------------------------------------
  api-gateway:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - admin-services
      - member-services
      - publishing-services
  certbot:
    image: certbot/certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    command: docker-compose run --rm certbot certonly --webroot --webroot-path /var/www/certbot -d duck-api.duckdns.org --email echotech8310@gmail.com --agree-tos --no-eff-email

  # -----------------------------------------------------------
  # 2. DATABASE SERVICES
  # -----------------------------------------------------------
  db-services:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: echoAdza32
      MYSQL_USER: administrator
      MYSQL_PASSWORD: echoAdza32
    ports:
      - "3307:3306"
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - db-services:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "administrator",
          "-pechoAdza32",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # -----------------------------------------------------------
  # 3. MAILER (MAILHOG)
  # -----------------------------------------------------------
  mailer-services:
    image: mailhog/mailhog:latest
    ports:
      - "587:587" # SMTP
      - "8025:8025" # Web UI
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8025"]

  # -----------------------------------------------------------
  # 4. BACKEND APPLICATIONS
  # -----------------------------------------------------------

  admin-services:
    build:
      context: ./admin-services
      dockerfile: Dockerfile
    environment:
      DB_HOST: db-services
      DB_USER: administrator
      DB_PASSWORD: echoAdza32
      DB_NAME: admin_db
    ports:
      - "3001:3001"
    depends_on:
      db-services:
        condition: service_healthy
    # UPDATE: Tambah db:create biar aman kalau DB belum ada
    command: sh -c "(npx sequelize-cli db:create || true) && npx sequelize-cli db:migrate && node index.js"

  member-services:
    build:
      context: ./member-services
      dockerfile: Dockerfile
    environment:
      DB_HOST: db-services
      DB_USER: administrator
      DB_PASSWORD: echoAdza32
      DB_NAME: member_db
      # Mailer Config
      SMTP_HOST: mailhog
      SMTP_PORT: 587
      SMTP_SECURE: "false"
      FROM_EMAIL: "echotech8310@gmail.com"
      SMTP_SERVICE: "gmail"
      SMTP_USER: "echotech8310@gmail.com"
      SMTP_PASS: "abcdefghijklmnop"
    ports:
      - "3002:3002"
    depends_on:
      mailer-services:
        condition: service_started
      db-services:
        condition: service_healthy
    # UPDATE: Tambah db:create
    command: sh -c "(npx sequelize-cli db:create || true) && npx sequelize-cli db:migrate && node index.js"

  publishing-services:
    build:
      context: ./publishing-services
      dockerfile: Dockerfile
    environment:
      DB_HOST: db-services
      DB_USER: administrator
      DB_PASSWORD: echoAdza32
      DB_NAME: publishing_db
    ports:
      - "3003:3003"
    depends_on:
      db-services:
        condition: service_healthy
    # UPDATE: Tambah db:create
    command: sh -c "(npx sequelize-cli db:create || true) && npx sequelize-cli db:migrate && node index.js"

volumes:
  db-services:
