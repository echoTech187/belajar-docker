services:
  db-services:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: echoAdza32
      MYSQL_USER: administrator
      MYSQL_PASSWORD: echoAdza32
    ports:
      - "3307:3306"
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - db-services:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "administrator",
          "-pechoAdza32",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  mailer-services:
    image: mailhog/mailhog:latest
    ports:
      - "587:587" # SMTP port
      - "8025:8025" # Web UI port
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3000"]
  admin-services:
    build:
      context: ./admin-services
      dockerfile: Dockerfile
    environment:
      DB_HOST: db-services
      DB_USER: administrator
      DB_PASSWORD: echoAdza32
      DB_NAME: admin_db
    ports:
      - "3001:3001"
    depends_on:
      db-services:
        condition: service_healthy
    command: sh -c "npx sequelize-cli db:migrate && node index.js"
  member-services:
    build:
      context: ./member-services
      dockerfile: Dockerfile
    environment:
      DB_HOST: db-services
      DB_USER: administrator
      DB_PASSWORD: echoAdza32
      DB_NAME: member_db

      SMTP_HOST: mailhog
      SMTP_PORT: 587
      SMTP_SECURE: "false"
      FROM_EMAIL: "echotech8310@gmail.com"
    ports:
      - "3002:3002"
    depends_on:
      mailer-services:
        condition: service_started
      db-services:
        condition: service_healthy
    command: sh -c "npx sequelize-cli db:migrate && node index.js"
  publishing-services:
    build:
      context: ./publishing-services
      dockerfile: Dockerfile
    environment:
      DB_HOST: db-services
      DB_USER: administrator
      DB_PASSWORD: echoAdza32
      DB_NAME: publishing_db
    ports:
      - "3003:3003"
    depends_on:
      db-services:
        condition: service_healthy
    command: sh -c "npx sequelize-cli db:migrate && node index.js"
volumes:
  db-services:
